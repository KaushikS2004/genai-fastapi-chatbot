<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GenAI Chatbot</title>

  <!-- Markdown Renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      background: #fafafa;
    }

    h2 { margin-top: 30px; }

    input, textarea, button, select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
    }

    button { cursor: pointer; }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      max-height: 450px;
      overflow-y: auto;
      background: #fff;
    }

    .msg {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 6px;
      line-height: 1.5;
    }

    .user {
      background: #dcf8c6;
      text-align: right;
    }

    .assistant {
      background: #f1f0f0;
      text-align: left;
    }

    .success { color: green; }
    .error { color: red; }

    /* Markdown styling */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }

    th { background: #f5f5f5; }

    pre {
      background: #eee;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }

    code {
      background: #eee;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>

<body>

<h2>üßë‚Äçüíª Signup</h2>
<input id="su-username" placeholder="Username" />
<input id="su-password" type="password" placeholder="Password" />
<button onclick="signup()">Signup</button>
<div id="signup-msg"></div>

<hr />

<h2>üîê Login</h2>
<input id="li-username" placeholder="Username" />
<input id="li-password" type="password" placeholder="Password" />
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
<div id="login-msg"></div>
<div id="logout-msg"></div>

<hr />

<h2>üìé Upload Document</h2>
<input type="file" id="fileInput" />
<button onclick="uploadFile()">Upload File</button>
<div id="file-msg"></div>

<hr />

<h2>üí¨ Ask the AI</h2>

<div class="controls">
  <select id="mode">
    <option value="default">Default</option>
    <option value="coding">Coding</option>
    <option value="interview">Interview</option>
    <option value="explainer">Explainer</option>
  </select>

  <select id="format">
    <option value="auto">Auto</option>
    <option value="bullets">Bullets</option>
    <option value="table">Table</option>
    <option value="json">JSON</option>
  </select>

  <select id="tone">
    <option value="neutral">Neutral</option>
    <option value="simple">Simple</option>
    <option value="detailed">Detailed</option>
  </select>
</div>

<textarea id="prompt" rows="4" placeholder="Enter your prompt..."></textarea>
<button onclick="generate()">Generate</button>

<div id="output"></div>

<script>
  // ================= GLOBAL STATE =================
  let token = "";

  let sessionId = localStorage.getItem("session_id");
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem("session_id", sessionId);
  }

  // ================= UI =================
  function appendMessage(role, text) {
    const output = document.getElementById("output");
    const div = document.createElement("div");
    div.className = `msg ${role}`;

    const rendered = role === "assistant"
      ? marked.parse(text)
      : text;

    div.innerHTML = `<strong>${role === "user" ? "You" : "AI"}:</strong><br>${rendered}`;
    output.appendChild(div);
    output.scrollTop = output.scrollHeight;
  }

  // ================= AUTH =================
  async function signup() {
    try {
      const res = await fetch("/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: suUsername.value.trim(),
          password: suPassword.value.trim()
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Signup failed");

      signupMsg.innerText = "Signup successful. Please login.";
      signupMsg.className = "success";
    } catch (e) {
      signupMsg.innerText = e.message;
      signupMsg.className = "error";
    }
  }

  async function login() {
    try {
      const res = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: liUsername.value.trim(),
          password: liPassword.value.trim()
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error("Invalid username or password");

      token = data.access_token;
      loginMsg.innerText = "Login successful";
      loginMsg.className = "success";
    } catch (e) {
      loginMsg.innerText = e.message;
      loginMsg.className = "error";
    }
  }

  function logout() {
    token = "";
    localStorage.removeItem("session_id");
    sessionId = crypto.randomUUID();
    localStorage.setItem("session_id", sessionId);
    output.innerHTML = "";
    logoutMsg.innerText = "Logged out successfully";
    logoutMsg.className = "success";
  }

  // ================= FILE UPLOAD =================
  async function uploadFile() {
    if (!token) {
      alert("Please login first");
      return;
    }

    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(`/upload?session_id=${sessionId}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        },
        body: formData
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Upload failed");

      fileMsg.innerText = `‚úÖ Uploaded: ${data.filename}`;
      fileMsg.className = "success";
    } catch (e) {
      fileMsg.innerText = "‚ùå Upload failed";
      fileMsg.className = "error";
    }
  }

  // ================= STREAMING GENERATE =================
  async function generate() {
    if (!token) {
      alert("Please login first");
      return;
    }

    const text = prompt.value.trim();
    if (!text) return;

    appendMessage("user", text);
    prompt.value = "";

    const output = document.getElementById("output");
    const div = document.createElement("div");
    div.className = "msg assistant";
    div.innerHTML = "<strong>AI:</strong><br>";
    output.appendChild(div);

    try {
      const res = await fetch("/generate/stream", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          prompt: text,
          session_id: sessionId,
          mode: mode.value,
          format: format.value,
          tone: tone.value
        })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let fullText = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        fullText += decoder.decode(value);
        div.innerHTML = "<strong>AI:</strong><br>" + marked.parse(fullText);
        output.scrollTop = output.scrollHeight;
      }
    } catch {
      div.innerHTML += "‚ö†Ô∏è Error generating response";
    }
  }

  // ================= DOM =================
  const suUsername = document.getElementById("su-username");
  const suPassword = document.getElementById("su-password");
  const signupMsg = document.getElementById("signup-msg");

  const liUsername = document.getElementById("li-username");
  const liPassword = document.getElementById("li-password");
  const loginMsg = document.getElementById("login-msg");
  const logoutMsg = document.getElementById("logout-msg");

  const prompt = document.getElementById("prompt");
  const output = document.getElementById("output");

  const mode = document.getElementById("mode");
  const format = document.getElementById("format");
  const tone = document.getElementById("tone");

  const fileInput = document.getElementById("fileInput");
  const fileMsg = document.getElementById("file-msg");
</script>

</body>
</html>
